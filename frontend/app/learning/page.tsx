"use client";

import { useEffect, useState } from "react";
import Navigation from "../components/layout/Navigation";
import Footer from "../components/layout/Footer";
import PageWrapper from "../components/layout/PageWrapper";
import Card from "../components/ui/Card";

type Media = {
  id: number;
  media_type: "image" | "video" | "link" | "file";
  url: string;
  caption: string;
};

type LearningEntry = {
  id: number;
  title: string;
  content: string;
  created_at: string;
  updated_at: string;
  is_public: boolean;
  roadmap_item: number | null;
  roadmap_item_title?: string;
  section_title?: string;
  media: Media[];
};

type ParsedContent = {
  summary: string | null;
  raw: string;
};

const parseContent = (content: string): ParsedContent => {
  // Backend appends AI summary like: "<summary>\n\n---\nRaw event:\n<raw>"
  const marker = "\n---\nRaw event:\n";
  const idx = content.indexOf(marker);
  if (idx !== -1) {
    return {
      summary: content.slice(0, idx).trim(),
      raw: content.slice(idx + marker.length).trim(),
    };
  }
  return { summary: null, raw: content };
};

export default function LearningPage() {
  const [entries, setEntries] = useState<LearningEntry[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const load = async () => {
      try {
        const res = await fetch(
          `${process.env.NEXT_PUBLIC_API_BASE_URL}/api/learning/public/`
        );

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();
        setEntries(data);
      } catch (err) {
        console.error(err);
        setError("Failed to load learning entries");
      } finally {
        setLoading(false);
      }
    };

    load();
  }, []);

  return (
    <PageWrapper>
      <Navigation />

      {/* Hero Section */}
      <section className="bg-radial-red px-4 py-8 text-center md:p-16">
        <div className="mx-auto max-w-[900px]">
          <h1 className="text-gradient-red mb-3 text-[2rem] font-black tracking-tight md:mb-4 md:text-[3.5rem]">
            MCP Learning Log
          </h1>
          <p className="mb-4 text-base font-light text-text-gray md:mb-4 md:text-xl">
            My documented journey through AI and software development generated by MCP (Model Context Protocol) and intelligent agents
          </p>

          {/* MCP Explanation */}
          <div className="mx-auto max-w-[700px] rounded-lg border border-primary-red/20 bg-black/30 p-4 text-left md:p-6">
            <h3 className="mb-2 text-base font-semibold text-primary-red md:mb-3 md:text-lg">
              How MCP Generates Learning Logs
            </h3>
            <p className="mb-2 text-xs leading-relaxed text-text-light md:mb-3 md:text-sm">
              This portfolio uses <strong>Model Context Protocol (MCP)</strong> - a standardized interface that allows AI agents to access and manage my learning data through 5 specialized tools:
            </p>
            <ul className="mb-2 space-y-1.5 text-xs text-text-light md:mb-3 md:space-y-2 md:text-sm">
              <li className="flex items-start gap-2">
                <span className="text-primary-red">▸</span>
                <span>
                  <strong>get_roadmap</strong> - Fetches my AI learning roadmap structure
                </span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-primary-red">▸</span>
                <span>
                  <strong>search_knowledge</strong> - Performs semantic search across all my notes using RAG (Retrieval-Augmented Generation)
                </span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-primary-red">▸</span>
                <span>
                  <strong>add_learning_entry</strong> - Automatically creates new learning log entries
                </span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-primary-red">▸</span>
                <span>
                  <strong>get_learning_entries</strong> - Retrieves my learning history with filters
                </span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-primary-red">▸</span>
                <span>
                  <strong>get_progress_stats</strong> - Tracks my learning progress metrics
                </span>
              </li>
            </ul>
            <p className="text-xs leading-relaxed text-text-gray md:text-sm">
              A <strong>LangChain-powered agent</strong> orchestrates these tools intelligently - analyzing my GitHub commits, study sessions, and project work to automatically document my learning journey. The agent uses <strong>Groq&apos;s Llama 3.3</strong> for reasoning and <strong>Cohere embeddings</strong> for semantic understanding.
            </p>
          </div>

          <div className="divider-red mx-auto mt-4 md:mt-6" />
        </div>
      </section>

      {/* Content Section */}
      <section className="mx-auto max-w-[1200px] px-4 py-6 pb-12 md:px-8 md:py-8 md:pb-16">
        {loading && (
          <div className="p-8 text-center text-text-gray md:p-12">
            <p className="text-base md:text-lg">Loading learning entries...</p>
          </div>
        )}

        {error && (
          <div className="bg-card rounded-lg border border-primary-red/50 p-8 text-center md:p-12">
            <p className="text-base text-primary-red md:text-lg">{error}</p>
          </div>
        )}

        {!loading && !error && entries.length === 0 && (
          <div className="bg-card rounded-lg border border-primary-red/30 p-8 text-center md:p-12">
            <p className="text-base text-text-gray md:text-lg">No learning entries yet.</p>
          </div>
        )}

        {!loading && !error && entries.length > 0 && (
          <div className="flex flex-col gap-6 md:gap-8">
            {entries.map((entry) => {
              const { summary, raw } = parseContent(entry.content);
              const contentToShow = summary ?? raw;

              return (
                <Card key={entry.id}>
                  <h2 className="mb-2 text-xl font-bold text-primary-red md:mb-3 md:text-[1.75rem]">
                    {entry.title}
                  </h2>

                  {(entry.section_title || entry.roadmap_item_title) && (
                    <div className="mb-3 flex items-center gap-2 text-sm text-text-gray md:mb-4 md:text-[0.95rem]">
                      <span className="text-primary-red">▸</span>
                      {entry.section_title && <span>{entry.section_title}</span>}
                      {entry.section_title && entry.roadmap_item_title && <span>→</span>}
                      {entry.roadmap_item_title && <span>{entry.roadmap_item_title}</span>}
                    </div>
                  )}

                  <div className="mb-2 whitespace-pre-wrap rounded border border-primary-red/20 bg-black/30 p-3 text-sm leading-relaxed text-text-light md:p-4 md:text-base">
                    {contentToShow}
                  </div>

                  {summary && (
                    <div className="mb-4 text-xs text-text-gray md:text-sm">Generated with Groq</div>
                  )}

                  {entry.media.length > 0 && (
                    <div className="mb-3 rounded border border-primary-red/20 bg-black/30 p-3 md:mb-4 md:p-4">
                      <h3 className="mb-3 text-sm font-semibold text-primary-red md:mb-4 md:text-base">
                        Media Attachments
                      </h3>
                      <ul className="flex flex-col gap-3 p-0 md:gap-4">
                        {entry.media.map((m) => (
                          <li key={m.id} className="list-none">
                            {m.media_type === "image" ? (
                              <div>
                                <img
                                  src={m.url}
                                  alt={m.caption || "Media attachment"}
                                  className="max-w-full rounded border border-primary-red/20"
                                />
                                {m.caption && (
                                  <p className="mt-1.5 text-xs italic text-text-gray md:mt-2 md:text-sm">
                                    {m.caption}
                                  </p>
                                )}
                              </div>
                            ) : (
                              <a
                                href={m.url}
                                target="_blank"
                                rel="noreferrer"
                                className="flex items-center gap-2 rounded bg-primary-red/10 p-2 text-sm text-primary-red no-underline transition-colors hover:bg-primary-red/20"
                              >
                                <span>[link]</span>
                                <span className="truncate">{m.caption || m.url}</span>
                              </a>
                            )}
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}

                  <div className="border-t border-primary-red/20 pt-3 text-xs text-text-gray md:pt-4 md:text-sm">
                    Created:{" "}
                    {new Date(entry.created_at).toLocaleDateString("en-US", {
                      year: "numeric",
                      month: "long",
                      day: "numeric",
                      hour: "2-digit",
                      minute: "2-digit",
                    })}
                  </div>
                </Card>
              );
            })}
          </div>
        )}
      </section>

      <Footer />
    </PageWrapper>
  );
}
